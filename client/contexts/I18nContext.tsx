import React, { createContext, useContext, useMemo, useState, useEffect } from "react";

export type Language = "uz" | "ru" | "en";

type Dictionary = Record<string, string> | Record<string, any>;

const dictionaries: Record<Language, Dictionary> = {
  uz: {
    units: {
      years: "yosh",
      cm: "sm",
      kg: "kg",
      kcalPerDay: "kkal/kun",
    },
    general: {
      back: "Orqaga",
      next: "Keyingi",
      save: "Saqlash",
      finish: "Tugallash",
      loading: "Yuklanmoqda...",
      language: "Til",
      today: "Bugun",
      success: "Muvaffaqiyat",
      error: "Xatolik",
    },
    pages: {
      addMeal: { title: "Ovqat qo'shish", subtitle: "Sog'liq kuzatuvi", save: "Ovqatni Saqlash" },
      water: { title: "Suv Tracker", add: "Suv qo'shish", history7: "So'nggi 7 kun" },
      steps: { title: "Qadam Tracker", quickAdd: "Tezkor qo'shish" },
      daily: { title: "Kundalik tracking" },
      home: {
        hello: "Salom",
        nutrition: "Oziq-ovqat tarkibi",
        progress: "Maqsadga jarayon",
        consumed: "Iste'mol qilingan",
        left: "qoldi",
        details: "Batafsil",
        averageWeek: "Bu hafta o'rtacha",
        avgCalories: "O'rtacha kaloriya",
        avgWorkout: "O'rtacha mashq",
        avgSleep: "O'rtacha uyqu",
        tracking: "Kuzatuvlar",
        steps: "Qadamlar",
        distanceKm: "km",
        sleep: "Uyqu",
        sleepQuality: "Sifat",
        sleepConsistency: "barqaror",
        workouts: "Mashqlar",
        weekTotal: "Haftalik jami",
        targetShort: "Maqsad",
        water: "Suv",
        waterGoalReached: "Maqsadga erishildi!",
        keepDrinking: "Ichishda davom eting",
        waterLeftSuffix: "qoldi",
        addWater: "Suv +1",
        addMeal: "Ovqat Qo'shish",
        stepPlus1K: "Qadam +1K",
        workoutPlus30m: "Mashq +30m",
        todaySummary: "Bugungi xulosa",
        overallGoal: "Umumiy maqsad",
        bmr: "BMR",
        calories: "Kcal",
        burned: "Yoqilgan",
        burnedToday: "Bugun yo'qilgan kaloriya",
        goal: "maqsad:",
      }
    },
    onboarding: {
      title: "Caloria AI'ga Xush Kelibsiz!",
      step: "Qadam",
      personalInfo: "Asosiy Ma'lumotlar",
      gender: "Jinsingiz",
      male: "Erkak",
      female: "Ayol",
      birthYear: "Tug'ilgan yil",
      physical: "Jismoniy O'lchamlar",
      height: "Bo'yingiz (sm)",
      weight: "Vazningiz (kg)",
      goals: "Maqsad va Faollik",
      activity: "Faollik darajangiz",
      goal: "Maqsadingiz",
      low: "Kam faol",
      medium: "O'rtacha faol",
      high: "Juda faol",
      lose: "Vazn kamaytirish",
      maintain: "Vaznni saqlash",
      gain: "Vazn ko'paytirish",
      sleepTime: "Uxlash vaqti (ixtiyoriy)",
      wakeTime: "Uyg'onish vaqti (ixtiyoriy)",
      complete: "Tugallash",
      stepTitles: {
        welcome: "Xush kelibsiz!",
        basicInfo: "Asosiy ma'lumotlar",
        physicalInfo: "Jismoniy ma'lumotlar",
        goals: "Maqsadlar",
        schedule: "Kundalik rejim",
        complete: "Tayyor!",
      },
      errors: {
        enterName: "Iltimos, ismingizni kiriting",
        enterHeightWeight: "Iltimos, bo'y va vaznni kiriting",
        heightRange: "Bo'y 100-250 sm oralig'ida bo'lishi kerak",
        weightRange: "Vazn 30-300 kg oralig'ida bo'lishi kerak",
        saved: "Ma'lumotlar muvaffaqiyatli saqlandi!",
        unknown: "Xatolik yuz berdi. Qaytadan urinib ko'ring.",
      },
    },
    profile: {
      title: "Shaxsiy Kabinet",
      profileInfo: "Profil Ma'lumotlari",
      edit: "Tahrirlash",
      cancel: "Bekor qilish",
      name: "Ism",
      namePlaceholder: "Ismingizni kiriting",
      gender: "Jins",
      age: "Yosh",
      height: "Bo'y",
      weight: "Vazn",
      activity: "Faollik",
      goal: "Maqsad",
      settings: "Sozlamalar",
      dailyCaloriesTitle: "Kunlik Kaloriya",
      interfaceLanguage: "Interfeys tili",
      currentLanguage: "Joriy",
      savedLanguage: "Saqlangan",
      notifications: "Bildirishnomalar",
      notificationsSubtitle: "Ovqat va suv eslatmalari",
      meals: "Ovqat",
      water: "Suv",
      aiTipsTitle: "AI Maslahatlar",
      aiTipsDescription: "Shaxsiy AI tavsiyalari",
      exportData: "Ma'lumotlarni eksport qilish",
      clearProfile: "Profilni tozalash",
      notFound: "Profil topilmadi",
      pleaseRegister: "Iltimos, avval ro'yxatdan o'ting",
      register: "Ro'yxatdan o'tish",
    },
  },
  ru: {
    units: {
      years: "лет",
      cm: "см",
      kg: "кг",
      kcalPerDay: "ккал/день",
    },
    general: {
      back: "Назад",
      next: "Далее",
      save: "Сохранить",
      finish: "Завершить",
      loading: "Загрузка...",
      language: "Язык",
      today: "Сегодня",
      success: "Успех",
      error: "Ошибка",
    },
    pages: {
      addMeal: { title: "Добавить блюдо", subtitle: "Мониторинг здоровья", save: "Сохранить блюдо" },
      water: { title: "Трекер воды", add: "Добавить воду", history7: "Последние 7 дней" },
      steps: { title: "Трекер шагов", quickAdd: "Быстро добавить" },
      daily: { title: "Ежедневный трекинг" },
      home: {
        hello: "Привет",
        nutrition: "Состав питания",
        progress: "Прогресс цели",
        consumed: "Употреблено",
        left: "осталось",
        details: "Подробнее",
        averageWeek: "Средние за неделю",
        avgCalories: "Средние калории",
        avgWorkout: "Средние тренировки",
        avgSleep: "Средний сон",
        tracking: "Отслеживание",
        steps: "Шаги",
        distanceKm: "км",
        sleep: "Сон",
        sleepQuality: "Качество",
        sleepConsistency: "стабильность",
        workouts: "Тренировки",
        weekTotal: "Итог за неделю",
        targetShort: "Цель",
        water: "Вода",
        waterGoalReached: "Цель достигнута!",
        keepDrinking: "Продолжайте пить",
        waterLeftSuffix: "осталось",
        addWater: "Вода +1",
        addMeal: "Добавить блюдо",
        stepPlus1K: "+1K шагов",
        workoutPlus30m: "+30м тренировка",
        todaySummary: "Итоги дня",
        overallGoal: "Общая цель",
        bmr: "BMR",
        calories: "Ккал",
        burned: "Сожжено",
        burnedToday: "Сожжено сегодня",
        goal: "цель:",
      }
    },
    onboarding: {
      title: "Добро пожаловать в Caloria AI!",
      step: "Шаг",
      personalInfo: "Основные данные",
      gender: "Ваш пол",
      male: "Мужчина",
      female: "Женщина",
      birthYear: "Год рождения",
      physical: "Физические параметры",
      height: "Рост (см)",
      weight: "Вес (кг)",
      goals: "Цели и активность",
      activity: "Уровень активности",
      goal: "Ваша цель",
      low: "Малоподвижный",
      medium: "Средняя активность",
      high: "Высокая активность",
      lose: "Похудение",
      maintain: "Поддержание веса",
      gain: "Набор веса",
      sleepTime: "Время сна (необязательно)",
      wakeTime: "Время подъема (необязательно)",
      complete: "Завершение",
      stepTitles: {
        welcome: "Добро пожаловать!",
        basicInfo: "Основные данные",
        physicalInfo: "Физические параметры",
        goals: "Цели",
        schedule: "Ежедневный режим",
        complete: "Готово!",
      },
      errors: {
        enterName: "Пожалуйста, введите имя",
        enterHeightWeight: "Пожалуйста, введите рост и вес",
        heightRange: "Рост должен быть в диапазоне 100–250 см",
        weightRange: "Вес должен быть в диапазоне 30–300 кг",
        saved: "Данные успешно сохранены!",
        unknown: "Произошла ошибка. Попробуйте еще раз.",
      },
    },
    profile: {
      title: "Личный кабинет",
      profileInfo: "Данные профиля",
      edit: "Редактировать",
      cancel: "Отмена",
      name: "Имя",
      namePlaceholder: "Введите ваше имя",
      gender: "Пол",
      age: "Возраст",
      height: "Рост",
      weight: "Вес",
      activity: "Активность",
      goal: "Цель",
      settings: "Настройки",
      dailyCaloriesTitle: "Дневные калории",
      interfaceLanguage: "Язык интерфейса",
      currentLanguage: "Текущий",
      savedLanguage: "Сохранённый",
      notifications: "Уведомления",
      notificationsSubtitle: "Напоминания о еде и воде",
      meals: "Еда",
      water: "Вода",
      aiTipsTitle: "AI рекомендации",
      aiTipsDescription: "Персональные советы AI",
      exportData: "Экспорт данных",
      clearProfile: "Очистить профиль",
      notFound: "Профиль не найден",
      pleaseRegister: "Пожалуйста, сначала пройдите регистрацию",
      register: "Зарегистрироваться",
    },
  },
  en: {
    units: {
      years: "years",
      cm: "cm",
      kg: "kg",
      kcalPerDay: "kcal/day",
    },
    general: {
      back: "Back",
      next: "Next",
      save: "Save",
      finish: "Finish",
      loading: "Loading...",
      language: "Language",
      today: "Today",
      success: "Success",
      error: "Error",
    },
    pages: {
      addMeal: { title: "Add Meal", subtitle: "Health tracking", save: "Save Meal" },
      water: { title: "Water Tracker", add: "Add water", history7: "Last 7 days" },
      steps: { title: "Step Tracker", quickAdd: "Quick add" },
      daily: { title: "Daily tracking" },
      home: {
        hello: "Hello",
        nutrition: "Nutrition",
        progress: "Goal progress",
        consumed: "Consumed",
        left: "left",
        details: "Details",
        averageWeek: "Weekly averages",
        avgCalories: "Avg calories",
        avgWorkout: "Avg workout",
        avgSleep: "Avg sleep",
        tracking: "Tracking",
        steps: "Steps",
        distanceKm: "km",
        sleep: "Sleep",
        sleepQuality: "Quality",
        sleepConsistency: "consistency",
        workouts: "Workouts",
        weekTotal: "Week total",
        targetShort: "Target",
        water: "Water",
        waterGoalReached: "Goal reached!",
        keepDrinking: "Keep drinking",
        waterLeftSuffix: "left",
        addWater: "Water +1",
        addMeal: "Add Meal",
        stepPlus1K: "Steps +1K",
        workoutPlus30m: "Workout +30m",
        todaySummary: "Today's summary",
        overallGoal: "Overall goal",
        bmr: "BMR",
        calories: "Kcal",
        burned: "Burned",
        burnedToday: "Calories burned today",
        goal: "goal:",
      }
    },
    onboarding: {
      title: "Welcome to Caloria AI!",
      step: "Step",
      personalInfo: "Personal Information",
      gender: "Your gender",
      male: "Male",
      female: "Female",
      birthYear: "Birth year",
      physical: "Physical Measurements",
      height: "Height (cm)",
      weight: "Weight (kg)",
      goals: "Goals & Activity",
      activity: "Activity level",
      goal: "Your goal",
      low: "Sedentary",
      medium: "Moderate",
      high: "High",
      lose: "Lose weight",
      maintain: "Maintain weight",
      gain: "Gain weight",
      sleepTime: "Bedtime (optional)",
      wakeTime: "Wake time (optional)",
      complete: "Complete",
      stepTitles: {
        welcome: "Welcome!",
        basicInfo: "Basic info",
        physicalInfo: "Physical info",
        goals: "Goals",
        schedule: "Daily schedule",
        complete: "Ready!",
      },
      errors: {
        enterName: "Please enter your name",
        enterHeightWeight: "Please enter height and weight",
        heightRange: "Height must be between 100–250 cm",
        weightRange: "Weight must be between 30–300 kg",
        saved: "Data saved successfully!",
        unknown: "An error occurred. Please try again.",
      },
    },
    profile: {
      title: "Profile",
      profileInfo: "Profile Information",
      edit: "Edit",
      cancel: "Cancel",
      name: "Name",
      namePlaceholder: "Enter your name",
      gender: "Gender",
      age: "Age",
      height: "Height",
      weight: "Weight",
      activity: "Activity",
      goal: "Goal",
      settings: "Settings",
      dailyCaloriesTitle: "Daily Calories",
      interfaceLanguage: "Interface language",
      currentLanguage: "Current",
      savedLanguage: "Saved",
      notifications: "Notifications",
      notificationsSubtitle: "Meal and water reminders",
      meals: "Meals",
      water: "Water",
      aiTipsTitle: "AI Tips",
      aiTipsDescription: "Personalized AI recommendations",
      exportData: "Export data",
      clearProfile: "Clear profile",
      notFound: "Profile not found",
      pleaseRegister: "Please complete onboarding first",
      register: "Start onboarding",
    },
  },
};

export interface I18nContextValue {
  language: Language;
  setLanguage: (lang: Language) => void;
  t: (path: string) => string;
}

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

export const I18nProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [language, setLanguageState] = useState<Language>(() => {
    const saved = localStorage.getItem("app_language") as Language | null;
    return saved || "uz";
  });

  useEffect(() => {
    localStorage.setItem("app_language", language);
  }, [language]);

  const setLanguage = (lang: Language) => setLanguageState(lang);

  const t = useMemo(() => {
    const get = (path: string) => {
      const parts = path.split(".");
      let cur: any = dictionaries[language];
      for (const p of parts) {
        cur = cur?.[p];
      }
      return typeof cur === "string" ? cur : path;
    };
    return get;
  }, [language]);

  const value: I18nContextValue = { language, setLanguage, t };
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = (): I18nContextValue => {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error("useI18n must be used within I18nProvider");
  return ctx;
};

